#!/bin/bash
# setup-ralph - Bootstrap Ralph in any project
# Creates CLAUDE.md (with Ralph instructions) + progress.txt
# Claude will interview you to create PRD.md
#
# Usage: setup-ralph
# https://www.aihero.dev/getting-started-with-ralph

set -e

# Check if already initialized
if [[ -f "CLAUDE.md" ]] && grep -q "Ralph Workflow" CLAUDE.md 2>/dev/null; then
    echo "âš ï¸  Ralph already initialized in this directory."
    echo -n "Reinitialize? This will overwrite CLAUDE.md (y/N) "
    read -r response
    [[ ! "$response" =~ ^[Yy]$ ]] && exit 0
fi

# Create CLAUDE.md with Ralph instructions
cat > CLAUDE.md << 'CLAUDE_EOF'
# Project Instructions

## Ralph Workflow

This project uses the **Ralph** workflow - an AI coding loop where you (Claude) work through tasks one at a time, committing after each.

### How to Determine What to Do

**Check for PRD.md first:**

1. **If PRD.md is MISSING or EMPTY:**
   â†’ Interview the user to create it:
   - Ask what they're building (be specific)
   - Ask about tech stack preferences
   - Ask about key features and requirements
   - Break their vision into small tasks (~15-30 min each)
   - Create PRD.md with prioritized task list (use `- [ ]` checkboxes)
   - Mark tasks with ğŸ¤– (autonomous) or ğŸ§‘ (needs human)
   - Ask if they want you to start implementing

2. **If PRD.md EXISTS with INCOMPLETE tasks (has `- [ ]` items):**
   â†’ Follow the Ralph implementation loop:
   - Read PRD.md and progress.txt
   - Find the highest-priority incomplete ğŸ¤– task
   - Implement ONLY that single task
   - Run tests and type checks (MUST pass before committing)
   - Mark task complete in PRD.md (`- [x]`)
   - Append to progress.txt with timestamp
   - Commit with descriptive message
   - **Signal completion** (see Completion Protocol below)

3. **If PRD.md is COMPLETE (all tasks are `- [x]`):**
   â†’ Celebrate and offer next steps:
   - Congratulate the user!
   - Ask if they want to add more features
   - If yes, interview them and add new tasks to PRD.md

### Completion Protocol (CRITICAL)

After completing each task and committing, you MUST signal completion by outputting:

```
<promise>COMPLETE</promise>
```

This token tells the ralph-loop orchestrator that you've finished the current task.
The orchestrator will then:
1. Detect the completion token
2. Check if more ğŸ¤– tasks remain
3. Automatically continue with the next task

**Important:** Output `<promise>COMPLETE</promise>` AFTER:
- The task is fully implemented
- Tests pass
- Code is committed
- progress.txt is updated

### Autonomous Mode

When running under `ralph-loop`, you operate autonomously:
- Work through ğŸ¤– tasks sequentially without asking
- Skip ğŸ§‘ tasks (document them in HANDOFF.md)
- Output `<promise>COMPLETE</promise>` after each task
- Stop only when:
  - All ğŸ¤– tasks are complete
  - You encounter an error you can't resolve after 3 attempts

### Critical Rules

- **ONE TASK AT A TIME** - Never work on multiple tasks in one iteration
- **TESTS MUST PASS** - Run tests before every commit. Fix failures before committing.
- **TYPE CHECKS MUST PASS** - Run type checks (tsc, mypy, etc.) before committing
- **SMALL COMMITS** - Each commit = one completed task
- **UPDATE PROGRESS** - Always append to progress.txt with what you did and when
- **SIGNAL COMPLETION** - Always output `<promise>COMPLETE</promise>` when done

### Frontend Feedback Loop (Browser Tools)

When working on frontend/UI tasks and browser tools are available:

1. **After implementing a UI change**, use browser tools to verify:
   - Navigate to the relevant page
   - Check that the component renders correctly
   - Look for console errors or warnings
   - Test basic interactions (clicks, form inputs)

2. **Before committing frontend work**:
   - Take a snapshot or screenshot to verify the UI looks correct
   - Check browser console for errors
   - If issues are found, fix them before committing

3. **For interactive features**:
   - Test the user flow in the browser
   - Verify forms submit correctly
   - Check error states and edge cases

This creates a tight feedback loop: implement â†’ verify in browser â†’ fix issues â†’ commit.

### Task Sizing Guide

Good tasks (~15-30 min):
- "Create login form component"
- "Add API endpoint for user creation"
- "Write tests for authentication service"

Too big (break these down):
- "Implement user authentication" â†’ Break into: form, API, validation, session, tests
- "Build the dashboard" â†’ Break into: layout, widgets, data fetching, etc.

### Progress Format

When updating progress.txt, use this format:
```
[YYYY-MM-DD HH:MM] Completed: <task description>
- <what you did>
- <any notes or decisions made>
```

## Project-Specific Notes

<!-- Add your project-specific context below -->
<!-- Tech stack, coding conventions, files to avoid, etc. -->

CLAUDE_EOF

echo "âœ… Created CLAUDE.md with Ralph workflow instructions"

# Create progress.txt if it doesn't exist
if [[ ! -f "progress.txt" ]]; then
    touch progress.txt
    echo "âœ… Created progress.txt"
else
    echo "ğŸ“ progress.txt already exists (keeping it)"
fi

# Show status
echo ""
echo "ğŸš€ Ralph initialized!"
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚  Next: Run 'claude' and describe what you want to build â”‚"
echo "â”‚  Claude will interview you and create your PRD.md       â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚  For frontend projects, use: claude --chrome            â”‚"
echo "â”‚  (enables browser verification before each commit)      â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

if [[ -f "PRD.md" ]]; then
    echo "ğŸ“‹ Existing PRD.md found - Claude will continue from there"
else
    echo "ğŸ“‹ No PRD.md yet - Claude will help you create one"
fi

if [[ ! -d ".git" ]]; then
    echo ""
    echo "ğŸ’¡ Tip: Run 'git init' first if you want Ralph to commit changes"
fi
